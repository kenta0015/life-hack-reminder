# 調査: 写真アップロードで白画面 → 元の画面に戻りアップロード完了しない

## 現象

1. 「写真を選ぶ」タップ → フォトライブラリで画像を選択
2. **画面が真っ白になる**（1枚目の画像）
3. 数秒後に編集画面に戻るが、**写真は反映されていない**（2枚目の画像の状態）

---

## コードの流れ

1. **edit.tsx**（または add.tsx）の `onPress`  
   `const uri = await pickImageAndCopyToApp();` → `if (uri) setImagePickedUri(uri);`
2. **lib/imagePicker.ts** の `pickImageAndCopyToApp()`  
   - `requestMediaLibraryPermissionsAsync()`  
   - `launchImageLibraryAsync({ allowsEditing: true, ... })`  
   - iOS の場合: 返ってきた `sourceUri` は **tmp ディレクトリの file://** であることが多い  
   - `import("expo-file-system/legacy")`  
   - `FileSystem.makeDirectoryAsync(dir)`  
   - `FileSystem.copyAsync({ from: sourceUri, to: destUri })`  
   - 成功時: `return destUri` / 失敗時: `catch { return sourceUri }`

---

## 原因候補（優先度順）

### 1. 【最有力】iOS で `copyAsync` の「tmp からのコピー」が失敗している

**根拠**: [expo/expo#30108](https://github.com/expo/expo/issues/30108)

- **事実**: `expo-file-system` の `copyAsync` は、**ソースがアプリの tmp ディレクトリ**だと iOS で「File is not readable」で失敗する。
- **理由**: iOS 側のパーミッション判定が、bundle / caches / documents のみ許可しており、**tmp を読む許可を出していない**ため。
- **当プロジェクトとの関係**:
  - `expo-image-picker` の `allowsEditing: true` は、クロップ結果を **tmp に保存**し、その file:// URI を返す。
  - その URI を `copyAsync` の `from` に渡しているため、**tmp からのコピー**になっている。
  - その時点で **copyAsync が失敗（Promise reject）** する可能性が高い。

**catch で sourceUri を返しているのになぜ「アップロード完了しない」か**

- `copyAsync` が **reject する**と、`catch { return sourceUri; }` で tmp の URI は返る想定。
- ただし次の可能性がある:
  - **Native 側でクラッシュやエラー**になり、JS の catch に到達する前にアプリが白画面→復帰している（その間の Promise がどう扱われるかは環境依存）。
  - **別の箇所で未処理の reject**（例: `import("expo-file-system/legacy")` や `requestMediaLibraryPermissionsAsync` / `launchImageLibraryAsync`）があり、そこで未処理の Promise rejection → エラーオーバーレイ／白画面 → 復帰時にコンポーネントがアンマウントして state がリセットされ、`setImagePickedUri` が効いていない。

---

### 2. 呼び出し側の未処理 Promise rejection

**根拠**: edit.tsx / add.tsx の `onPress` に try/catch がない。

```ts
onPress={async () => {
  const uri = await pickImageAndCopyToApp();  // ここで reject すると未処理
  if (uri) setImagePickedUri(uri);
  ...
}}
```

- `pickImageAndCopyToApp()` の**外側**（権限、ピッカー起動、dynamic import、copyAsync のいずれか）で reject すると、**未処理の Promise rejection** になる。
- Expo / React Native では、未処理 rejection でエラー表示や白画面になり、復帰時にツリーが再マウントされ、**編集画面の state が初期値に戻る**ため、「写真が反映されない」ように見える。

---

### 3. ネイティブピッカー表示中のアンマウント

- フォトライブラリを開いているあいだに、何らかの理由で編集画面がアンマウントすることがある。
- ピッカーを閉じたあと、`pickImageAndCopyToApp()` が完了して `setImagePickedUri(uri)` を呼んでも、**別インスタンス**や**既にアンマウントした**コンポーネントに対する setState になり、画面には反映されない可能性がある。
- 白画面が「ピッカーを閉じた直後」に起きているなら、上記 1 や 2 と組み合わさっている可能性が高い。

---

## 結論（短く）

| 要因 | 内容 |
|------|------|
| **直接の引き金** | iOS で画像ピッカーが **tmp の file://** を返し、**expo-file-system の copyAsync が tmp からのコピーを許可していない**ため失敗している可能性が高い。 |
| **白画面** | copyAsync の失敗や、権限・import など別箇所の **未処理の Promise rejection** により、Expo がエラー表示／白画面にして、復帰時にコンポーネントが再マウントされている可能性。 |
| **アップロード完了しない** | 再マウントで state がリセットされる、または reject で `setImagePickedUri` まで到達していないため、画面に写真が反映されない。 |

---

## 修正方針（✅ 実装済み）

1. **tmp の場合は copyAsync をスキップ**（採用・実装済み）  
   - ピッカーで取得した URI が **tmp を含む**（iOS の tmp）場合は、**copyAsync を呼ばずその URI をそのまま返す**。  
   - 表示・保存は tmp の URI のまま。白画面と「アップロード完了しない」を防ぐ。  
   - ※ tmp のファイルは OS が削除することがあるため、長時間後に画像が消える可能性はある。

2. **pickImageAndCopyToApp 全体を try/catch**（採用・実装済み）  
   - 権限・ピッカー・import・copy のどこで失敗しても **throw しない**。外側の catch で `return null` にし、未処理 rejection を防ぐ。

3. **呼び出し側で try/catch**（採用・実装済み）  
   - edit.tsx / add.tsx の「写真を選ぶ」onPress 内で `pickImageAndCopyToApp()` を **try/catch** で囲み、catch 時はアラート「エラーが発生しました。もう一度お試しください。」を表示。

---

## 参照

- [expo/expo#30108](https://github.com/expo/expo/issues/30108) — `copyAsync` fails on file in `tmp` directory on iOS  
- 本プロジェクト: `lib/imagePicker.ts`, `app/edit.tsx`, `app/add.tsx`
