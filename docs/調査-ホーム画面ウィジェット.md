# ホーム画面ウィジェット 調査メモ（life-hack-reminder）

実装は行わず、将来 Phase 2 でウィジェットをやるときの前提調査としてまとめる。  
他プロジェクト（todo-reminder）で得た結論と、本プロジェクト用の差分・SDK 54 の注意点を記載する。

---

## 結論（短く）

- **公式 `expo-widgets`（npm）**: いまも 0.0.0 のプレースホルダで、実装・Config Plugin ともに**使えない**。Expo 55 で公式が alpha として出る可能性はあるが、現時点では前提にしない。
- **現実的な選択肢**: サードパーティの **@bittingz/expo-widgets** または **@bacons/apple-targets**。どちらも Swift でウィジェット UI を書き、Config Plugin でウィジェット拡張を追加し、**App Group** でアプリとウィジェット間のデータ共有を行う。
- **他プロジェクトでの推奨**: @bittingz/expo-widgets で進める方針でドキュメント化済み（既存の App Group `group.com.kenta0015.todo-reminder` を流用可能だった）。

---

## 選択肢の整理

| 項目 | 公式 expo-widgets | @bittingz/expo-widgets | @bacons/apple-targets |
|------|-------------------|------------------------|------------------------|
| 状態 | 0.0.0 プレースホルダ、未使用 | v3.0.2、Expo 51+、実運用実績あり | 実験的、SDK 53+ |
| UI | － | Swift で記述 | `npx create-target widget` 後、Xcode で Swift |
| Config Plugin | なし | あり（devTeamId, src, App Group） | あり（ターゲット生成） |
| データ共有 | － | App Group の UserDefaults 等 | 同様に App Group を利用 |
| **Expo SDK 54** | － | **prebuild で Podfile パターンマッチ失敗の既知不具合あり**（未解決の可能性） | **BaseMods API 変更でエラー。patch-package で回避可能** |

### 推奨方針（他プロジェクトの結論を踏まえ）

- **第一候補**: **@bittingz/expo-widgets**  
  - 他プロジェクトで採用済み・ドキュメントあり。Swift でウィジェットを書く流れが確立している。
  - **注意**: 本プロジェクトは **Expo 54**。@bittingz は SDK 54 で `expo prebuild` 時に Podfile のパターンマッチに失敗する issue が報告されている。実装着手時に最新版・issue を確認し、修正 or パッチがなければ **@bacons/apple-targets + patch** を検討する。
- **第二候補**: **@bacons/apple-targets**  
  - SDK 54 では `@expo/config-plugins` の API 変更でエラーになるが、[patch-package による回避手順](https://github.com/EvanBacon/expo-apple-targets/issues/144) が共有されている。@bittingz が SDK 54 で使えない場合のフォールバックとして現実的。

---

## life-hack-reminder 固有の前提

### App Group

- **他プロジェクト**: `group.com.kenta0015.todo-reminder` を利用。
- **本プロジェクト**: 別アプリのため **新規に App Group を用意する**想定。  
  - 例: `group.com.kenta0015.life-hack-reminder`  
  - Developer で App ID と App Group を登録し、メインアプリとウィジェット拡張の両方で有効化する。

### ウィジェットが表示するもの（仕様「画像ドーン」）

- 仕様: ホーム画面に「画像＋言葉」をドーンと出す。対象は Life Cards / Nudges / Playbooks 全部。
- ウィジェット用にメインアプリから書き出すデータの例:
  - **表示用 1 件分**: 「次に配信するアイテム」または「今日の 1 枚」用。
  - 想定キー・型（App Group の UserDefaults に書き出す場合）:
    - `widgetPhrase`: string（短い言葉／Nudge テキスト／Playbook タイトル）
    - `widgetImageUrl`: string?（Life Card の画像 URL、任意）
    - `widgetTitle`: string?（Life Card タイトルや Playbook タイトル等）
    - `widgetType`: "lifeCard" | "nudge" | "playbook"
    - `widgetUpdatedAt`: number（最終更新時刻。ウィジェットの更新トリガー用）
  - 配信スケジュールが「月水金 9:00」なら、そのタイミングに合わせてメインアプリ（またはバックグラウンド）が「次に表示する 1 件」を選び、上記形式で書き出す。

### メインアプリ側の役割

- アイテムの保存・更新・削除・配信シミュレート時に、「ウィジェット用に表示する 1 件」を決定し、App Group の UserDefaults に書き出す。
- 実装方針: **ネイティブモジュール 1 本**（または既存の何かとまとめたモジュール）で、JS から「このオブジェクトをウィジェット用に書き出して」と渡し、ネイティブ側で UserDefaults に保存する。

---

## @bittingz で進める場合の流れ（SDK 54 で動くことを確認できた場合）

1. **インストールと app.json / app.config**
   - `npx expo install @bittingz/expo-widgets`
   - plugin 設定: `devTeamId`, `src`（ウィジェット Swift のパス）, **App Group**（`group.com.kenta0015.life-hack-reminder` など）

2. **widgets/ios/ の構成**
   - Module.swift、WidgetBundle、実際のウィジェット（例: `LifeHackWidget`）を Swift で記述。
   - 表示内容: 上記 `widgetPhrase` / `widgetImageUrl` / `widgetTitle` / `widgetType` を UserDefaults（App Group）から読み、レイアウトに反映。

3. **ウィジェット用データ形式**
   - App Group の UserDefaults に、上記キー・型で「次リマインド／今日の 1 枚」を書き出す。
   - メインアプリ側: 保存・配信ロジックの適切なタイミングで、選ばれた 1 件をネイティブモジュール経由で書き出す。

4. **prebuild → Developer 設定 → 実機**
   - `npx expo prebuild --platform ios`（SDK 54 で @bittingz のエラーが出る場合は、パッチ or @bacons 検討）。
   - Apple Developer で App ID・App Group を設定し、実機でウィジェット表示を確認。

---

## 実装チェックリスト（将来着手時）

- [ ] 選択肢の再確認（@bittingz の SDK 54 対応状況 or @bacons + patch）
- [ ] `@bittingz/expo-widgets` または `@bacons/apple-targets` のインストールと plugin 設定（devTeamId, src, App Group）
- [ ] App Group の新規作成（例: `group.com.kenta0015.life-hack-reminder`）
- [ ] widgets/ios/ の Swift ウィジェット（WidgetBundle、表示レイアウト）
- [ ] ウィジェット用データ形式の確定と、UserDefaults キー・型の定義
- [ ] メインアプリ側: 書き出し用ネイティブモジュール（または既存モジュール拡張）の実装と、保存・配信タイミングでの呼び出し
- [ ] prebuild（必要なら patch）→ Developer で App ID / App Group 設定
- [ ] 実機でウィジェット表示・更新の確認

---

## 公式が使えるようになった場合

- 公式 `expo-widgets` が実用レベルになったら、**ウィジェット用のデータ形式（キー・型）を揃えておけば**、差し替えしやすい。
- 上記の `widgetPhrase` / `widgetImageUrl` / `widgetTitle` / `widgetType` / `widgetUpdatedAt` を「ウィジェット契約」として固定し、メインアプリの書き出しだけ共通にしておくことを推奨。

---

## 参照

- 全体の段階計画: [PLAN-実機テストと将来仕様.md](./PLAN-実機テストと将来仕様.md)
- 他プロジェクトのウィジェット方針: 同様の内容で `doc/plan-phase2-widgets.md` に記載済み（@bittingz 推奨、App Group `group.com.kenta0015.todo-reminder`）
- @bittingz/expo-widgets: [npm](https://www.npmjs.com/package/@bittingz/expo-widgets) / [GitHub (mike-stewart-dev/expo-widgets)](https://github.com/mike-stewart-dev/expo-widgets)
- @bittingz SDK 54 Podfile 問題: [expo-widgets issue #68](https://github.com/mike-stewart-dev/expo-widgets/issues/68)
- @bacons/apple-targets SDK 54 対応: [expo-apple-targets issue #144](https://github.com/EvanBacon/expo-apple-targets/issues/144)
